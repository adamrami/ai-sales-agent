<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8; /* Lighter background for a cleaner look */
            color: #334155;
        }
        .whitespace-pre-wrap {
            white-space: pre-wrap;
        }
        .container-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 3rem;
        }
        input, select, textarea {
            border: 1px solid #cbd5e1;
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6; /* Blue for a modern, professional feel */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        .btn-primary {
            background-color: #1e3a8a; /* Darker blue for a professional tone */
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #1e40af;
        }
        .copy-btn:hover svg {
            color: #1e40af;
        }
        .bg-gray-input {
            background-color: #f8fafc;
        }

        /* Animation Keyframes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes zoomIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        /* Animation Classes */
        .animate-fade-in { animation: fadeIn 1s ease-in-out; }
        .animate-slide-up { animation: slideInUp 1s ease-in-out; }
        .animate-zoom-in { animation: zoomIn 1s ease-in-out; }
    </style>
</head>
<body class="p-6 md:p-10 flex items-start justify-center min-h-screen">
    <div class="w-full max-w-4xl container-card">
        <!-- Main Application Content -->
        <div id="mainContent">
            <div class="text-center mb-4">
                <div class="flex items-center justify-center space-x-4">
                    <img src="https://icons.iconarchive.com/icons/noctuline/wall-e/128/EVE-icon.png" alt="EVE Icon" class="w-12 h-12" />
                    <h1 class="text-4xl font-bold text-slate-800" data-lang="appTitle">AI Sales Agent</h1>
                </div>
                <p class="mt-2 text-lg text-slate-500" data-lang="appSubtitle">Generate personalized emails with three distinct tones.</p>
                <button id="showHelpBtn" class="text-sm font-medium text-slate-500 hover:text-blue-600 transition-colors duration-200 mt-2 inline-block" data-lang="helpFAQ">Help & FAQ</button>
            </div>
            
            <p id="userIdDisplay" class="text-sm text-slate-400 text-center mb-6 hidden" data-lang="yourUserID">Ditt Användar-ID: </p>
            
            <!-- Random Sales Quote Section -->
            <div id="quoteSection" class="mt-8 mb-8 p-6 bg-blue-100 rounded-xl text-center shadow-md">
                <p id="quoteText" class="text-blue-900 font-semibold italic text-lg"></p>
            </div>

            <!-- Coaching Corner -->
            <div id="coachingCorner" class="mt-12 p-8 bg-gray-50 border border-gray-200 rounded-xl animate-fade-in">
                <h2 class="text-xl font-bold text-gray-800 mb-4" data-lang="coachingCornerTitle">Coaching Corner</h2>
                <p id="coachingTip" class="text-gray-600 italic"></p>
            </div>
    
            <!-- Input Form -->
            <form id="emailForm" class="space-y-6">
                <!-- Language Selector -->
                <div class="p-6 border border-gray-200 rounded-xl bg-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-lang="languageSelectorTitle">Språk</h2>
                    <label for="languageSelector" class="block text-sm font-medium text-slate-700" data-lang="selectLanguageLabel">Välj Språk</label>
                    <select id="languageSelector" name="languageSelector" class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-white" onchange="changeLanguage(this.value)">
                        <option value="sv" selected>Svenska</option>
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="fa">فارسی (Persiska)</option>
                    </select>
                </div>
                
                <!-- My Info Section -->
                <div class="p-6 border border-gray-200 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-lang="myInfoTitle">Mina Uppgifter</h2>
                    <div id="myInfoForm">
                        <div class="space-y-6">
                            <div>
                                <label for="myName" class="block text-sm font-medium text-slate-700" data-lang="myNameLabel">Mitt Namn</label>
                                <input type="text" id="myName" name="myName" data-lang-placeholder="myNamePlaceholder" placeholder="t.ex. John Smith"
                                       class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                            </div>
                            <div>
                                <label for="myRole" class="block text-sm font-medium text-slate-700" data-lang="myRoleLabel">Min Roll</label>
                                <input type="text" id="myRole" name="myRole" data-lang-placeholder="myRolePlaceholder" placeholder="t.ex. Försäljningschef"
                                       class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                            </div>
                            <div>
                                <label for="myServices" class="block text-sm font-medium text-slate-700" data-lang="myServicesLabel">Mina Tjänster/Värdeerbjudande</label>
                                <textarea id="myServices" name="myServices" rows="3" data-lang-placeholder="myServicesPlaceholder" placeholder="t.ex. Vi erbjuder molnbaserad ERP-mjukvara med fokus på fältservice och resursoptimering."
                                          class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input"></textarea>
                            </div>
                            <button type="button" id="saveMyInfoBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md text-sm font-medium text-white shadow-sm bg-indigo-600 hover:bg-indigo-700" data-lang="saveMyInfoButton">
                                Spara Mina Uppgifter
                            </button>
                        </div>
                    </div>
                    <div id="myInfoSaved" class="hidden">
                        <p class="text-slate-600"><span data-lang="myNameLabel">Mitt Namn</span>: <span id="savedMyName" class="font-bold"></span></p>
                        <p class="text-slate-600"><span data-lang="myRoleLabel">Min Roll</span>: <span id="savedMyRole" class="font-bold"></span></p>
                        <p class="text-slate-600" data-lang="myServicesLabel">Mina Tjänster/Värdeerbjudande: <span id="savedMyServices" class="font-bold"></span></p>
                        <button type="button" id="changeMyInfoBtn" class="text-sm font-medium text-blue-600 hover:underline mt-2" data-lang="changeButton">Ändra</button>
                    </div>
                </div>

                <!-- My Company Section -->
                <div class="p-6 border border-gray-200 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-lang="myCompanyTitle">Mitt Företag</h2>
                    <div>
                        <label for="sourceCompanySelector" class="block text-sm font-medium text-slate-700" data-lang="myCompanySelectLabel">Mitt Företag<span class="text-red-500">*</span></label>
                        <select id="sourceCompanySelector" name="sourceCompanySelector" required class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                            <option value="">(Välj ditt företag)</option>
                            <option value="IFS">IFS</option>
                            <option value="SAP">SAP</option>
                            <option value="Oracle">Oracle</option>
                            <option value="Other">Other (Anpassad)</option>
                        </select>
                    </div>
                    <div id="customCompanyFields" class="space-y-6 mt-6 hidden">
                        <div>
                            <label for="sourceCompanyName" class="block text-sm font-medium text-slate-700" data-lang="myCompanyNameLabel">Mitt Företagsnamn<span class="text-red-500">*</span></label>
                            <input type="text" id="sourceCompanyName" name="sourceCompanyName" data-lang-placeholder="myCompanyNamePlaceholder" placeholder="t.ex. Ditt företag"
                                   class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                        </div>
                        <div>
                            <label for="sourceCompanyWebsite" class="block text-sm font-medium text-slate-700" data-lang="myCompanyWebsiteLabel">Min Företagswebbplats (URL)<span class="text-red-500">*</span></label>
                            <input type="text" id="sourceCompanyWebsite" name="sourceCompanyWebsite" data-lang-placeholder="myCompanyWebsitePlaceholder" placeholder="t.ex. www.dittforetag.com"
                                   class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                        </div>
                    </div>
                </div>

                <!-- Customer Section -->
                <div class="p-6 border border-gray-200 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-4" data-lang="customerTitle">Kund</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-slate-700" data-lang="customerNameLabel">Kundens Namn<span class="text-red-500">*</span></label>
                            <input type="text" id="customerName" name="customerName" data-lang-placeholder="customerNamePlaceholder" placeholder="John Doe" required
                                   class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                        </div>
                        <div>
                            <label for="customerBusiness" class="block text-sm font-medium text-slate-700" data-lang="customerBusinessLabel">Kundens Bransch/Verksamhet<span class="text-red-500">*</span></label>
                            <input type="text" id="customerBusiness" name="customerBusiness" data-lang-placeholder="customerBusinessPlaceholder" placeholder="E-handelslogistik" required
                                   class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                        </div>
                    </div>
        
                    <div>
                        <label for="customerWebsite" class="block text-sm font-medium text-slate-700" data-lang="customerWebsiteLabel">Kundens Webbplats (URL)</label>
                        <input type="text" id="customerWebsite" name="customerWebsite" data-lang-placeholder="customerWebsitePlaceholder" placeholder="www.exempel.com"
                               class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                    </div>

                    <div>
                        <label for="annualReportUrl" class="block text-sm font-medium text-slate-700" data-lang="annualReportUrlLabel">Kundens Årsredovisning (URL)</label>
                        <input type="text" id="annualReportUrl" name="annualReportUrl" data-lang-placeholder="annualReportUrlPlaceholder" placeholder="Länk till kundens senaste årsredovisning"
                               class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                    </div>
        
                    <div>
                        <label for="linkedinProfile" class="block text-sm font-medium text-slate-700" data-lang="linkedinProfileLabel">Kundens LinkedIn-profil (URL)</label>
                        <input type="text" id="linkedinProfile" name="linkedinProfile" data-lang-placeholder="linkedinProfilePlaceholder" placeholder="linkedin.com/in/johndoe"
                               class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                    </div>
        
                    <div>
                        <label for="personalityType" class="block text-sm font-medium text-slate-700" data-lang="personalityTypeLabel">Kundens Personlighetstyp (valfritt)</label>
                        <select id="personalityType" name="personalityType" class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                            <option value="" data-lang="selectOneOption">(Välj en)</option>
                            <option value="Analytical" data-lang="analyticalOption">Analytisk (Älskar data, detaljer och logik)</option>
                            <option value="Driver" data-lang="driverOption">Drivande (Målmedveten, beslutsam och värdesätter effektivitet)</option>
                            <option value="Amiable" data-lang="amiableOption">Vänlig (Relationsfokuserad, värdesätter tillit och harmoni)</option>
                            <option value="Expressive" data-lang="expressiveOption">Expressiv (Entusiastisk, innovativ och älskar den stora bilden)</option>
                        </select>
                    </div>
        
                    <div>
                        <label for="competitorSolution" class="block text-sm font-medium text-slate-700" data-lang="competitorSolutionLabel">Konkurrentprodukt (valfritt)</label>
                        <textarea id="competitorSolution" name="competitorSolution" rows="2" data-lang-placeholder="competitorSolutionPlaceholder" placeholder="t.ex. SAP, Oracle, NetSuite"
                                  class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input"></textarea>
                    </div>

                    <div>
                        <label for="messageLength" class="block text-sm font-medium text-slate-700" data-lang="messageLengthLabel">Meddelandelängd<span class="text-red-500">*</span></label>
                        <select id="messageLength" name="messageLength" required class="mt-1 block w-full rounded-md shadow-sm focus:outline-none p-3 bg-gray-input">
                            <option value="short" data-lang="shortOption">Kort och koncist</option>
                            <option value="moderate" data-lang="moderateOption">Måttlig</option>
                            <option value="detailed" data-lang="detailedOption">Detaljerad</option>
                            <option value="surprise" data-lang="surpriseOption">Överraska mig</option>
                        </select>
                    </div>
                </div>
    
                <button type="submit" id="generateBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md text-sm font-medium text-white shadow-sm btn-primary" data-lang="generateButton">
                    Generera E-postmeddelanden
                </button>
            </form>
            
            <!-- Loading Indicator -->
            <div id="loading" class="mt-8 text-center hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-600 border-opacity-25 mx-auto"></div>
                <p class="mt-4 text-slate-600" data-lang="loadingText">Genererar pitchar, vänligen vänta...</p>
            </div>
    
            <!-- Email Output Container -->
            <div id="results" class="mt-8 hidden">
                <!-- Sales Manager Analysis -->
                <div id="managerAnalysis" class="bg-blue-50 p-6 rounded-xl border border-blue-200 mb-8 hidden">
                    <h2 class="text-xl font-bold text-blue-800 mb-2" data-lang="analysisTitle">Säljchefens Analys</h2>
                    <p id="analysisText" class="text-blue-700"></p>
                </div>
    
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-4" data-lang="generatedPitchesTitle">Genererade E-postpitchar</h2>
                <div id="emailContainer" class="space-y-6"></div>
            </div>
            
            <!-- Public Emails Section -->
            <div class="mt-12 pt-8 border-t border-slate-300">
                <h2 class="text-2xl font-bold text-slate-800 text-center mb-4" data-lang="publicHistoryTitle">Offentlig E-posthistorik</h2>
                <div id="publicEmails" class="space-y-6">
                    <p class="text-slate-500 text-center" data-lang="loadingPublicHistory">Laddar offentlig e-posthistorik...</p>
                </div>
            </div>
        </div>

        <!-- Help Page Content -->
        <div id="helpContent" class="hidden">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold text-slate-800" data-lang="helpPageTitle">Hjälp & FAQ</h1>
                <p class="mt-2 text-lg text-slate-500" data-lang="helpPageSubtitle">Hur man använder det här verktyget och svar på vanliga frågor.</p>
                <button id="hideHelpBtn" class="text-sm font-medium text-slate-500 hover:text-blue-600 transition-colors duration-200 mt-2 inline-block" data-lang="backToAgentButton">Till Säljagenten</button>
            </div>

            <div class="space-y-8">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2" data-lang="howToUseTitle">Hur man använder agenten</h2>
                    <p class="text-slate-600" data-lang="howToUseDesc">
                        AI-säljagenten är utformad för att hjälpa dig att snabbt generera personliga e-postpitchar av hög kvalitet med olika tonlägen. Genom att tillhandahålla nyckelinformation om en kund och deras företag kan agenten skapa e-postmeddelanden som är skräddarsydda, relevanta och har större chans att få svar.
                    </p>
                    <ul class="list-decimal list-inside text-slate-600 mt-4 space-y-2">
                        <li data-lang="howToUsePoint1">**Fyll i formuläret:** Formuläret är där du anger all information AI:n behöver för att generera de bästa e-postutkasten. Inmatningar som **Kundens Webbplats** och **Kundens LinkedIn-profil** är valfria men rekommenderas starkt för att få de mest exakta resultaten.</li>
                        <li data-lang="howToUsePoint2">**Välj Personlighetstyp:** Detta är en kraftfull funktion som påverkar AI:ns rekommendation. Att välja en personlighetstyp hjälper agenten att välja det bästa tonläget för att matcha kundens kommunikationsstil.</li>
                        <li data-lang="howToUsePoint3">**Generera E-postmeddelanden:** Klicka på **"Generera E-postmeddelanden"**-knappen. AI:n kommer att bearbeta din inmatning och presentera tre e-postutkast: Professionell, Engagerande och Avslappnad.</li>
                        <li data-lang="howToUsePoint4">**Granska Analysen:** **"Säljchefens Analys"**-rutan visas högst upp. Denna ger en rekommendation om vilket tonläge som passar bäst för kunden baserat på den valda personlighetstypen.</li>
                        <li data-lang="howToUsePoint5">**Välj & Kopiera:** Granska de genererade e-postmeddelandena. När du hittar det du gillar klickar du bara på **"Kopiera"**-knappen bredvid det. E-postens ämne och brödtext kopieras till ditt urklipp, redo att klistras in i din e-postklient.</li>
                    </ul>
                </div>

                <hr class="border-t border-slate-300">

                <div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2" data-lang="faqTitle">Vanliga frågor</h2>
                    <div class="space-y-4">
                        <p class="font-bold text-slate-800" data-lang="faqQuestion1">F: Varför finns det tre olika tonlägen i e-postmeddelandet?</p>
                        <p class="text-slate-600" data-lang="faqAnswer1">
                            **S:** Olika människor svarar på olika kommunikationsstilar. Den **Professionella** tonen är idealisk för analytiska personligheter, medan den **Engagerande** tonen är bäst för uttrycksfulla kunder. Den **Avslappnade** tonen är ett bra, kort alternativ som respekterar kundens tid.
                        </p>
                        <p class="font-bold text-slate-800" data-lang="faqQuestion2">F: Hur fungerar inmatningen av "Personlighetstyp"?</p>
                        <p class="text-slate-600" data-lang="faqAnswer2">
                            **S:** Den här funktionen bygger på vanliga personlighetsramar som används inom försäljning. Den hjälper AI:n att rekommendera det mest effektiva tonläget och kommunikationsstilen för din kund, vilket ökar dina chanser att få ett positivt svar.
                        </p>
                        <p class="font-bold text-slate-800" data-lang="faqQuestion3">F: Sparas och delas min data?</p>
                        <p class="text-slate-600" data-lang="faqAnswer3">
                            **S:** Kundens namn och verksamhet, tillsammans med den bästa tonrekommendationen, sparas i en offentlig databas så att du kan se en historik över genererade e-postmeddelanden från andra användare. Detta är endast för samarbetsändamål och inkluderar ingen privat eller känslig information.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // **********************************************
        // START: GLOBAL DATA AND CONFIGURATION (Must be at the top of the module)
        // **********************************************
        // Core Firebase/App variables (must be defined early in module scope)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length !== 0 ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        let app, db, auth, userId = null;
        let isFirebaseActive = false;

        let currentLang = localStorage.getItem('appLang') || 'sv'; 

        // Competitor Data
        const competitorData = {
            "IFS": "SAP, Oracle, Microsoft Dynamics 365, Infor",
            "SAP": "Oracle, Microsoft Dynamics 365, IFS, Infor",
            "Oracle": "SAP, Microsoft Dynamics 365, IFS, Workday",
            "Other": ""
        };

        // Sales quotes for inspiration
        const salesQuotes = [
            "Your most unhappy customers are your greatest source of learning. - Bill Gates",
            "The best way to predict the future is to create it. - Peter Drucker",
            "A sale is not something you do to someone, it's something you do with someone. - Zig Ziglar",
            "Don't sell a product, sell an outcome. - Mark Cuban",
            "The secret to getting ahead is getting started. - Mark Twain",
            "The key to success is to focus on goals, not obstacles. - Anonymous",
            "You miss 100% of the shots you don’t take. - Wayne Gretzky",
            "Either you run the day, or the day runs you. - Jim Rohn",
            "If you are not taking care of your customer, your competitor will. - Bob Hooey",
            "The best salespeople are great listeners. - Brian Tracy",
            "Habit is the intersection of knowledge, skill, and desire. - Stephen Covey",
            "Be proactive. The most important freedom is the freedom to choose your response to life's events. - Stephen Covey",
            "Begin with the end in mind. Visualize your destination so you know what you are working towards. - Stephen Covey",
            "Put first things first. Discipline is the ability to prioritize your actions around your purpose. - Stephen Covey",
            "Seek first to understand, then to be understood. Listen with the intent to understand, not the intent to reply. - Stephen Covey",
            "Think win-win. Look for solutions that benefit both you and the customer. - Stephen Covey",
            "Synergize. Two heads are better than one; work together to achieve greater results. - Stephen Covey",
            "Sharpen the saw. Take time for self-care to maintain your most valuable asset: yourself. - Stephen Covey",
            "The only way on earth to influence other people is to talk about what they want and show them how to get it. - Dale Carnegie",
            "A person's name is to that person the sweetest and most important sound in any language. - Dale Carnegie",
            "Remember that a man's heart, like a lock, can be opened in only one way, and that is to talk in terms of what he wants. - Dale Carnegie",
            "If you want to gather honey, don't kick over the beehive. - Dale Carnegie",
            "Show genuine interest. Smile and be a good listener. - Dale Carnegie",
            "Show respect for the other person’s opinions. Never say, 'You're wrong.' - Dale Carnegie"
        ];
        
        const coachingTips = [
            `**Begin with the end in mind.** Before you draft an email, what is your ultimate goal? What is the customer's most likely challenge? When you know the destination, every word you use will have purpose.`,
            `**Seek first to understand, then to be understood.** Your customer is a person with a problem. Listen more than you talk. Ask insightful questions that show you genuinely care about their business, not just about making a sale.`,
            `**Think win-win.** A great deal leaves both parties feeling successful. Your goal is to find a solution that helps the customer solve their challenge while also being a strong fit for your product. It's about collaboration, not coercion.`,
            `**Be proactive.** Don't wait for a response. Take initiative to research the customer and their business. The AI agent can help, but your personal touch and preparation make all the difference.`,
            `**Talk in terms of what they want.** Dale Carnegie taught us that the only way to influence people is to talk about what they want and show them how to get it. Frame your entire pitch around their needs, not your product's features.`,
            `**Remember their name.** A person's name is the sweetest and most important sound to them. Use it naturally and respectfully in your communications to build a genuine connection.`,
            `**Listen effectively.** You can make more friends in two months by being genuinely interested in other people than you can in two years by trying to get other people interested in you. Be a great listener.`,
            `**Don't criticize, condemn, or complain.** Start your interaction on a positive note. Find something to genuinely admire about their company or recent news, and build from there.`,
            `**Handle objections gracefully.** Don't tell them they're wrong. Acknowledge their opinion, show respect, and then offer an alternative perspective. It's about finding a path forward together.`,
            `**Create a sense of urgency, but in a positive way.** Focus on the value they're missing out on by not acting, not on the pressure of a deadline. "The sooner you start, the sooner you'll see results."`
        ];
        
        const animationClasses = ['animate-fade-in', 'animate-slide-up', 'animate-zoom-in'];
        
        const companyData = {
            "IFS": {
                name: "IFS",
                website: "https://www.ifs.com",
                highlights: [
                    "A single, unified cloud platform for ERP, Enterprise Asset Management (EAM), and Field Service Management (FSM).",
                    "Industry-specific solutions tailored for industries like manufacturing, construction, energy, and aerospace.",
                    "Advanced project management capabilities with real-time tracking, resource allocation, and cost control.",
                    "Robust supply chain management to optimize inventory, procurement, and logistics.",
                    "Mobile-first design for field technicians and a user-friendly, adaptable interface.",
                    "Built-in analytics and business intelligence for data-driven decision making.",
                    "Servitization enablement to help companies transition from selling products to selling services."
                ]
            },
            "SAP": {
                name: "SAP S/4HANA",
                website: "https://www.sap.com/products/s4hana-erp.html",
                highlights: [
                    "An intelligent, integrated ERP system that runs on an in-memory database to enable real-time decision-making.",
                    "Combines traditional ERP with advanced technologies like AI and machine learning.",
                    "Provides a comprehensive suite of business applications for finance, supply chain, and more.",
                    "Known for its deep functionality and a wide array of modules for complex business processes.",
                    "Helps large enterprises manage global operations and scale across various industries.",
                    "Focuses on a streamlined digital core with simplified data models."
                ]
            },
            "Oracle": {
                name: "Oracle Cloud ERP",
                website: "https://www.oracle.com/erp/",
                highlights: [
                    "A complete and modern ERP system with built-in AI, machine learning, and advanced analytics.",
                    "Provides a full suite of applications for finance, procurement, project management, and risk management.",
                    "Offers continuous innovation with quarterly updates and a modern user interface.",
                    "Known for its strong financial management and robust reporting capabilities.",
                    "Helps businesses automate processes, increase agility, and gain a competitive advantage.",
                    "Provides a unified data model for a single source of truth across the enterprise."
                ]
            },
            "Other": {
                name: "",
                website: "",
                highlights: [
                    "A comprehensive business solution designed to streamline your operations and drive growth.",
                    "Integrates key business functions like finance, operations, and supply chain management on a single platform.",
                    "Provides real-time visibility and data-driven insights to support smarter decision-making.",
                    "Offers a flexible and scalable architecture that adapts to your unique industry and business needs.",
                    "Automates routine tasks and workflows to boost efficiency and productivity.",
                    "Features a user-centric design that enhances user adoption and simplifies complex processes."
                ]
            }
        };
        
        const languageData = {
            sv: {
                appTitle: "AI Säljagent",
                appSubtitle: "Generera personliga e-postmeddelanden med tre olika toner.",
                helpFAQ: "Hjälp & FAQ",
                yourUserID: "Ditt Användar-ID",
                selectLanguageLabel: "Välj Språk",
                coachingCornerTitle: "Coachinghörnan",
                myInfoTitle: "Mina Uppgifter",
                myNameLabel: "Mitt Namn",
                myNamePlaceholder: "t.ex. John Smith",
                myRoleLabel: "Min Roll",
                myRolePlaceholder: "t.ex. Försäljningschef",
                myServicesLabel: "Mina Tjänster/Värdeerbjudande",
                myServicesPlaceholder: "t.ex. Vi erbjuder molnbaserad ERP-mjukvara med fokus på fältservice och resursoptimering.",
                saveMyInfoButton: "Spara Mina Uppgifter",
                changeButton: "Ändra",
                myCompanyTitle: "Mitt Företag",
                myCompanySelectLabel: "Mitt Företag",
                myCompanyNameLabel: "Mitt Företagsnamn",
                myCompanyNamePlaceholder: "t.ex. Ditt företag",
                myCompanyWebsiteLabel: "Min Företagswebbplats (URL)",
                myCompanyWebsitePlaceholder: "t.ex. www.dittforetag.com",
                customerTitle: "Kund",
                customerNameLabel: "Kundens Namn",
                customerNamePlaceholder: "John Doe",
                customerBusinessLabel: "Kundens Bransch/Verksamhet",
                customerBusinessPlaceholder: "E-handelslogistik",
                customerWebsiteLabel: "Kundens Webbplats (URL)",
                customerWebsitePlaceholder: "www.exempel.com",
                annualReportUrlLabel: "Kundens Årsredovisning (URL)",
                annualReportUrlPlaceholder: "Länk till kundens senaste årsredovisning",
                linkedinProfileLabel: "Kundens LinkedIn-profil (URL)",
                personalityTypeLabel: "Kundens Personlighetstyp (valfritt)",
                selectOneOption: "(Välj en)",
                analyticalOption: "Analytisk (Älskar data, detaljer och logik)",
                driverOption: "Drivande (Målmedveten, beslutsam och värdesätter effektivitet)",
                amiableOption: "Vänlig (Relationsfokuserad, värdesätter tillit och harmoni)",
                expressiveOption: "Expressiv (Entusiastisk, innovativ och älskar den stora bilden)",
                competitorSolutionLabel: "Konkurrentprodukt (valfritt)",
                competitorSolutionPlaceholder: "t.ex. SAP, Oracle, NetSuite",
                messageLengthLabel: "Meddelandelängd",
                shortOption: "Kort och koncist (50-75 ord)",
                moderateOption: "Måttlig (120-180 ord)",
                detailedOption: "Detaljerad (200-300 ord)",
                surpriseOption: "Överraska mig",
                generateButton: "Generera E-postmeddelanden",
                loadingText: "Genererar pitchar, vänligen vänta...",
                analysisTitle: "Säljchefens Analys",
                generatedPitchesTitle: "Genererade E-postpitchar",
                publicHistoryTitle: "Offentlig E-posthistorik",
                loadingPublicHistory: "Laddar offentlig e-posthistorik...",
                copyButton: "Kopiera",
                sendEmailButton: "Skicka E-post",
                copiedText: "Kopierat!",
                featureUnavailable: "Funktion otillgänglig lokalt!",
                deployMessage: "AI-e-postgenerering kräver distribution till en serverlös plattform som Vercel.",
                analysisBase: "Baserat på kundens personlighetstyp",
                analysisRecommendation: "är den bästa metoden att använda ett",
                analysisTone: "tonläge",
                analysisConclusion: "Detta tonläge stämmer överens med deras kommunikationsstil, vilket hjälper dig att bygga relationer och förmedla ditt budskap effektivt.",
                analysisNoPersonality: "Ingen personlighetstyp valdes. Vi rekommenderar att börja med ett"
            },
            en: {
                appTitle: "AI Sales Agent",
                appSubtitle: "Generate personalized emails with three distinct tones.",
                helpFAQ: "Help & FAQ",
                yourUserID: "Your User ID",
                selectLanguageLabel: "Select Language",
                coachingCornerTitle: "Coaching Corner",
                myInfoTitle: "My Info",
                myNameLabel: "My Name",
                myNamePlaceholder: "e.g., John Smith",
                myRoleLabel: "My Role",
                myRolePlaceholder: "e.g., Sales Manager",
                myServicesLabel: "My Services/Value Proposition",
                myServicesPlaceholder: "e.g., We offer cloud-based ERP software focused on field service and resource optimization.",
                saveMyInfoButton: "Save My Info",
                changeButton: "Change",
                myCompanyTitle: "My Company",
                myCompanySelectLabel: "My Company",
                myCompanyNameLabel: "My Company Name",
                myCompanyNamePlaceholder: "e.g., Your company",
                myCompanyWebsiteLabel: "My Company Website (URL)",
                myCompanyWebsitePlaceholder: "e.g., www.yourcompany.com",
                customerTitle: "Customer",
                customerNameLabel: "Customer Name",
                customerNamePlaceholder: "John Doe",
                customerBusinessLabel: "Customer Business/Industry",
                customerBusinessPlaceholder: "E-commerce logistics",
                customerWebsiteLabel: "Customer Website (URL)",
                customerWebsitePlaceholder: "www.example.com",
                annualReportUrlLabel: "Customer Annual Report (URL)",
                annualReportUrlPlaceholder: "Link to the customer's latest annual report",
                linkedinProfileLabel: "Customer LinkedIn Profile (URL)",
                linkedinProfilePlaceholder: "linkedin.com/in/johndoe",
                personalityTypeLabel: "Customer Personality Type (optional)",
                selectOneOption: "(Select one)",
                analyticalOption: "Analytical (Loves data, details, and logic)",
                driverOption: "Driver (Goal-oriented, decisive, and values efficiency)",
                amiableOption: "Amiable (Relationship-focused, values trust and harmony)",
                expressiveOption: "Expressive (Enthusiastic, innovative, and loves the big picture)",
                competitorSolutionLabel: "Competitor Product (optional)",
                messageLengthLabel: "Message Length",
                shortOption: "Short and to the Point (50-75 words)",
                moderateOption: "Moderate (120-180 words)",
                detailedOption: "Detailed (200-300 words)",
                surpriseOption: "Surprise me",
                generateButton: "Generate Emails",
                loadingText: "Generating pitches, please wait...",
                analysisTitle: "Sales Manager's Analysis",
                generatedPitchesTitle: "Generated Email Pitches",
                publicHistoryTitle: "Public Email History",
                loadingPublicHistory: "Loading public email history...",
                copyButton: "Copy",
                sendEmailButton: "Send Email",
                copiedText: "Copied!",
                featureUnavailable: "Feature Unavailable Locally!",
                deployMessage: "AI email generation requires deployment to a serverless platform like Vercel.",
                analysisBase: "Based on the customer's personality type",
                analysisRecommendation: "the best approach is to use a",
                analysisTone: "tone",
                analysisConclusion: "This tone aligns with their communication style, helping you build rapport and effectively convey your message.",
                analysisNoPersonality: "No personality type was selected. We recommend starting with a"
            },
            es: {
                appTitle: "Agente de Ventas IA",
                appSubtitle: "Genere correos electrónicos personalizados con tres tonos distintos.",
                helpFAQ: "Ayuda y Preguntas",
                yourUserID: "Tu ID de Usuario",
                selectLanguageLabel: "Seleccionar Idioma",
                coachingCornerTitle: "Rincón de Coaching",
                myInfoTitle: "Mi Información",
                myNameLabel: "Mi Nombre",
                myNamePlaceholder: "ej. Juan Pérez",
                myRoleLabel: "Mi Rol",
                myRolePlaceholder: "ej. Gerente de Ventas",
                myServicesLabel: "Mis Servicios/Propuesta de Valor",
                myServicesPlaceholder: "ej. Ofrecemos software ERP basado en la nube centrado en el servicio de campo y la optimización de recursos.",
                saveMyInfoButton: "Guardar Mi Información",
                changeButton: "Cambiar",
                myCompanyTitle: "Mi Empresa",
                myCompanySelectLabel: "Mi Empresa",
                myCompanyNameLabel: "Nombre de Mi Empresa",
                myCompanyNamePlaceholder: "ej. Tu empresa",
                myCompanyWebsiteLabel: "Sitio Web de Mi Empresa (URL)",
                myCompanyWebsitePlaceholder: "ej. www.tuempresa.com",
                customerTitle: "Cliente",
                customerNameLabel: "Nombre del Cliente",
                customerNamePlaceholder: "John Doe",
                customerBusinessLabel: "Negocio/Industria del Cliente",
                customerBusinessPlaceholder: "Logística de comercio electrónico",
                customerWebsiteLabel: "Sitio Web del Cliente (URL)",
                customerWebsitePlaceholder: "www.ejemplo.com",
                annualReportUrlLabel: "Informe Anual del Cliente (URL)",
                annualReportUrlPlaceholder: "Enlace al último informe anual del cliente",
                linkedinProfileLabel: "Perfil de LinkedIn del Cliente (URL)",
                linkedinProfilePlaceholder: "linkedin.com/in/johndoe",
                personalityTypeLabel: "Tipo de Personalidad del Cliente (opcional)",
                selectOneOption: "(Seleccionar uno)",
                analyticalOption: "Analítico (Ama los datos, detalles y la lógica)",
                driverOption: "Conductor (Orientado a objetivos, decisivo y valora la eficiencia)",
                amiableOption: "Amable (Centrado en relaciones, valora la confianza y la armonía)",
                expressiveOption: "Expresivo (Entusiasta, innovador y le gusta el panorama general)",
                competitorSolutionLabel: "Producto de la Competencia (opcional)",
                competitorSolutionPlaceholder: "ej. SAP, Oracle, NetSuite",
                messageLengthLabel: "Longitud del Mensaje",
                shortOption: "Corto y al grano (50-75 palabras)",
                moderateOption: "Moderado (120-180 palabras)",
                detailedOption: "Detallado (200-300 palabras)",
                surpriseOption: "Sorpréndeme",
                generateButton: "Generar Correos Electrónicos",
                loadingText: "Generando propuestas, por favor espere...",
                analysisTitle: "Análisis del Gerente de Ventas",
                generatedPitchesTitle: "Propuestas de Correo Electrónico Generadas",
                publicHistoryTitle: "Historial Público de Correos Electrónicos",
                loadingPublicHistory: "Cargando historial público de correos...",
                copyButton: "Copiar",
                sendEmailButton: "Enviar Correo",
                copiedText: "¡Copiado!",
                featureUnavailable: "¡Función no disponible localmente!",
                deployMessage: "La generación de correo electrónico con IA requiere la implementación en una plataforma sin servidor como Vercel.",
                analysisBase: "Basado en el tipo de personalidad del cliente",
                analysisRecommendation: "el mejor enfoque es usar un tono",
                analysisTone: "tono",
                analysisConclusion: "Este tono se alinea con su estilo de comunicación, ayudándole a construir una buena relación y transmitir su mensaje de manera efectiva.",
                analysisNoPersonality: "No se seleccionó el tipo de personalidad. Recomendamos comenzar con un tono"
            },
            fa: {
                appTitle: "نماینده فروش هوش مصنوعی",
                appSubtitle: "ایجاد ایمیل‌های شخصی‌سازی شده با سه لحن متمایز.",
                helpFAQ: "راهنما و سوالات متداول",
                yourUserID: "شناسه کاربری شما",
                selectLanguageLabel: "انتخاب زبان",
                coachingCornerTitle: "گوشه مربیگری",
                myInfoTitle: "اطلاعات من",
                myNameLabel: "نام من",
                myNamePlaceholder: "به عنوان مثال، جان اسمیت",
                myRoleLabel: "نقش من",
                myRolePlaceholder: "به عنوان مثال، مدیر فروش",
                myServicesLabel: "خدمات/ارزش پیشنهادی من",
                myServicesPlaceholder: "به عنوان مثال، ما نرم‌افزار ERP مبتنی بر ابر با تمرکز بر خدمات میدانی و بهینه‌سازی منابع ارائه می‌دهیم.",
                saveMyInfoButton: "ذخیره اطلاعات من",
                changeButton: "تغییر",
                myCompanyTitle: "شرکت من",
                myCompanySelectLabel: "شرکت من",
                myCompanyNameLabel: "نام شرکت من",
                myCompanyNamePlaceholder: "به عنوان مثال، شرکت شما",
                myCompanyWebsiteLabel: "وب‌سایت شرکت من (URL)",
                myCompanyWebsitePlaceholder: "به عنوان مثال، www.yourcompany.com",
                customerTitle: "مشتری",
                customerNameLabel: "نام مشتری",
                customerNamePlaceholder: "جان دو",
                customerBusinessLabel: "تجارت/صنعت مشتری",
                customerBusinessPlaceholder: "لجستیک تجارت الکترونیک",
                customerWebsiteLabel: "وب‌سایت مشتری (URL)",
                customerWebsitePlaceholder: "www.example.com",
                annualReportUrlLabel: "گزارش سالانه مشتری (URL)",
                linkedinProfileLabel: "پروفایل لینکدین مشتری (URL)",
                personalityTypeLabel: "نوع شخصیت مشتری (اختیاری)",
                selectOneOption: "(یکی را انتخاب کنید)",
                analyticalOption: "تحلیلی (علاقه‌مند به داده، جزئیات و منطق)",
                driverOption: "رهبر (هدف‌گرا، قاطع، و ارزش‌گذار به کارایی)",
                amiableOption: "دوستانه (رابطه‌محور، ارزش‌گذار به اعتماد و هماهنگی)",
                expressiveOption: "بیانگر (مشتاق، نوآور و دوست‌دار تصویر کلی)",
                competitorSolutionLabel: "محصول رقیب (اختیاری)",
                competitorSolutionPlaceholder: "به عنوان مثال، SAP, Oracle, NetSuite",
                messageLengthLabel: "طول پیام",
                shortOption: "کوتاه و دقیق (50-75 کلمه)",
                moderateOption: "متعادل (120-180 کلمه)",
                detailedOption: "مفصل (200-300 کلمه)",
                surpriseOption: "مرا شگفت‌زده کن",
                generateButton: "تولید ایمیل‌ها",
                loadingText: "در حال تولید پیشنهادات، لطفاً صبر کنید...",
                analysisTitle: "تحلیل مدیر فروش",
                generatedPitchesTitle: "ایمیل‌های تولید شده",
                publicHistoryTitle: "تاریخچه عمومی ایمیل",
                loadingPublicHistory: "در حال بارگذاری تاریخچه عمومی ایمیل...",
                copyButton: "کپی",
                sendEmailButton: "ارسال ایمیل",
                copiedText: "کپی شد!",
                featureUnavailable: "قابلیت در حالت محلی در دسترس نیست!",
                deployMessage: "تولید ایمیل با هوش مصنوعی نیاز به استقرار در یک پلتفرم بدون سرور مانند Vercel.",
                analysisBase: "بر اساس نوع شخصیت مشتری",
                analysisRecommendation: "بهترین رویکرد استفاده از لحن",
                analysisTone: "است",
                analysisConclusion: "این لحن با سبک ارتباطی آنها هماهنگ است و به شما کمک می‌کند تا رابطه برقرار کرده و پیام خود را به طور موثر منتقل کنید."
            }
        };

        // **********************************************
        // END: GLOBAL DATA AND CONFIGURATION
        // **********************************************
        
        // UI Navigation
        const mainContent = document.getElementById('mainContent');
        const helpContent = document.getElementById('helpContent');
        const showHelpBtn = document.getElementById('showHelpBtn');
        const hideHelpBtn = document.getElementById('hideHelpBtn');
        const myInfoForm = document.getElementById('myInfoForm');
        const myInfoSaved = document.getElementById('myInfoSaved');
        const saveMyInfoBtn = document.getElementById('saveMyInfoBtn');
        const changeMyInfoBtn = document.getElementById('changeMyInfoBtn');
        const myNameInput = document.getElementById('myName');
        const myRoleInput = document.getElementById('myRole');
        const myServicesInput = document.getElementById('myServices'); // New input
        const savedMyNameSpan = document.getElementById('savedMyName');
        const savedMyRoleSpan = document.getElementById('savedMyRole');
        const savedMyServicesSpan = document.getElementById('savedMyServices'); // New span
        const customCompanyFields = document.getElementById('customCompanyFields');
        const sourceCompanySelector = document.getElementById('sourceCompanySelector');
        const sourceCompanyNameInput = document.getElementById('sourceCompanyName');
        const sourceCompanyWebsiteInput = document.getElementById('sourceCompanyWebsite');

        showHelpBtn.addEventListener('click', () => {
            mainContent.classList.add('hidden');
            helpContent.classList.remove('hidden');
        });

        hideHelpBtn.addEventListener('click', () => {
            helpContent.classList.add('hidden');
            mainContent.classList.remove('hidden');
        });

        sourceCompanySelector.addEventListener('change', (e) => {
            if (e.target.value === 'Other') {
                customCompanyFields.classList.remove('hidden');
                sourceCompanyNameInput.setAttribute('required', 'required');
                sourceCompanyWebsiteInput.setAttribute('required', 'required');
            } else {
                customCompanyFields.classList.add('hidden');
                sourceCompanyNameInput.removeAttribute('required');
                sourceCompanyWebsiteInput.removeAttribute('required');
            }
            // Automatically populate competitors based on selected company
            populateCompetitors(e.target.value);
        });

        // Functions for My Info persistence
        function saveMyInfo() {
            const myName = myNameInput.value;
            const myRole = myRoleInput.value;
            const myServices = myServicesInput.value;

            if (myName && myRole && myServices) {
                // Use localStorage for saving personal info
                localStorage.setItem('myName', myName);
                localStorage.setItem('myRole', myRole);
                localStorage.setItem('myServices', myServices);
                loadMyInfo();
            }
        }

        function loadMyInfo() {
            const savedName = localStorage.getItem('myName');
            const savedRole = localStorage.getItem('myRole');
            const savedServices = localStorage.getItem('myServices');

            if (savedName && savedRole && savedServices) {
                myNameInput.value = savedName;
                myRoleInput.value = savedRole;
                myServicesInput.value = savedServices;

                savedMyNameSpan.textContent = savedName;
                savedMyRoleSpan.textContent = savedRole;
                savedMyServicesSpan.textContent = savedServices;

                myInfoForm.classList.add('hidden');
                myInfoSaved.classList.remove('hidden');
            } else {
                myInfoForm.classList.remove('hidden');
                myInfoSaved.classList.add('hidden');
            }
        }
        
        // Event listeners
        if (saveMyInfoBtn) {
            saveMyInfoBtn.addEventListener('click', saveMyInfo);
        }
        if (changeMyInfoBtn) {
            changeMyInfoBtn.addEventListener('click', () => {
                myInfoSaved.classList.add('hidden');
                myInfoForm.classList.remove('hidden');
            });
        }


        function populateCompetitors(companyName) {
            const competitorSolutionInput = document.getElementById('competitorSolution');
            const competitors = competitorData[companyName] || competitorData['Other'];
            competitorSolutionInput.value = competitors;
        }

        function loadInspirationalContent() {
            const quoteTextElement = document.getElementById('quoteText');
            const coachingTipElement = document.getElementById('coachingTip');
            
            // 1. Quotes
            var randomQuote = salesQuotes[Math.floor(Math.random() * salesQuotes.length)];
            var randomAnimationQuote = animationClasses[Math.floor(Math.random() * animationClasses.length)];
            
            if (quoteTextElement) {
                // Clear previous classes before adding new one to reset animation
                quoteTextElement.className = 'text-blue-900 font-semibold italic text-lg'; 
                void quoteTextElement.offsetWidth; // Trigger reflow for animation reset
                quoteTextElement.textContent = randomQuote;
                quoteTextElement.classList.add(randomAnimationQuote);
            }

            // 2. Coaching Tips
            var randomTip = coachingTips[Math.floor(Math.random() * coachingTips.length)];
            var randomAnimationQuote = animationClasses[Math.floor(Math.random() * animationClasses.length)];

            if (coachingTipElement) {
                // Clear previous classes before adding new one to reset animation
                coachingTipElement.className = 'text-gray-600 italic';
                void coachingTipElement.offsetWidth; // Trigger reflow for animation reset
                coachingTipElement.innerHTML = randomTip;
                coachingTipElement.classList.add(randomAnimationQuote);
            }
        }
        
        function setupPublicHistoryListener() {
            // Check if Firebase is active before setting up the listener
            if (!isFirebaseActive || !userId) {
                console.warn("Firebase is not active or user not authenticated. Skipping public history listener.");
                return;
            }

            const publicCollectionPath = `artifacts/${appId}/public/data/emails`;
            const q = query(collection(db, publicCollectionPath), orderBy('timestamp', 'desc'), limit(10));
            onSnapshot(q, (querySnapshot) => {
                const publicEmailsContainer = document.getElementById('publicEmails');
                publicEmailsContainer.innerHTML = '';
                if (querySnapshot.empty) {
                    publicEmailsContainer.innerHTML = `<p class="text-slate-500 text-center">${languageData[currentLang].loadingPublicHistory}</p>`;
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const emailData = doc.data();
                    const emailCard = `
                        <div class="bg-slate-50 rounded-lg p-4 shadow-md border border-slate-100">
                            <p class="text-sm font-medium text-slate-500 mb-2">Generated by: ${emailData.userId}</p>
                            <p class="font-bold text-slate-800">Customer: ${emailData.customerName}</p>
                            <p class="font-bold text-slate-800">Business: ${emailData.customerCompany}</p>
                            <p class="font-bold text-slate-800 mt-2">Best Tone: ${emailData.bestTone}</p>
                        </div>
                    `;
                    publicEmailsContainer.innerHTML += emailCard;
                });
            }, (error) => {
                console.error("Error listening to public emails:", error);
                document.getElementById('publicEmails').innerHTML = `<p class="text-red-500 text-center">${languageData[currentLang].failedToLoadHistory}</p>`;
            });
        }

        // Helper function to add a protocol if missing
        function addProtocol(url) {
            if (!url) return '';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            return `https://${url}`;
        }
        
        function initializeFirebase() {
            // Only initialize Firebase if a valid config is provided
            if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    isFirebaseActive = true;
                    
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initialAuthToken : null;
                    // Set up auth listeners
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('userIdDisplay').textContent = `${languageData[currentLang].yourUserID}: ${userId}`;
                            document.getElementById('userIdDisplay').classList.remove('hidden');
                            setupPublicHistoryListener();
                        } else {
                            if (initialAuthToken) {
                                try {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } catch (error) {
                                    console.error("Error signing in with custom token:", error);
                                    await signInAnonymously(auth);
                                }
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    });

                } catch (e) {
                    console.error("Firebase initialization failed:", e);
                    isFirebaseActive = false;
                }
            }
            
            if (!isFirebaseActive) {
                console.warn("Firebase is not active. The public email history feature will be disabled.");
                const publicEmailsContainer = document.getElementById('publicEmails');
                if (publicEmailsContainer) {
                    publicEmailsContainer.innerHTML = `
                        <div class="p-4 bg-yellow-100 rounded-md border border-yellow-200 text-yellow-800 text-center">
                            <p>${languageData[currentLang].publicHistoryUnavailable}</p>
                        </div>
                    `;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInspirationalContent();
            loadMyInfo(); // Load saved info after DOM is ready
            initializeFirebase(); // Initialize Firebase after functions are defined
            updateUI(currentLang);
        });

        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const selectedCompany = form.sourceCompanySelector.value;
            let myCompanyName = selectedCompany;
            let myCompanyWebsite = companyData[selectedCompany].website;
            let productHighlights = companyData[selectedCompany].highlights;
            
            if (selectedCompany === 'Other') {
                myCompanyName = form.sourceCompanyName.value;
                myCompanyWebsite = addProtocol(form.sourceCompanyWebsite.value);
                productHighlights = companyData['Other'].highlights;
            }

            const myName = myNameInput.value;
            const myRole = myRoleInput.value;
            const myServices = myServicesInput.value; // Get new services input
            const customerName = form.customerName.value;
            const customerCompany = form.customerBusiness.value;
            const customerWebsite = form.customerWebsite.value;
            const customerLinkedinProfile = form.linkedinProfile.value;
            const customerPersonalityType = form.personalityType.value;
            const competitorSolution = form.competitorSolution.value;
            const annualReportUrl = form.annualReportUrl.value;
            const messageLength = form.messageLength.value;
            
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('emailContainer').innerHTML = '';
            document.getElementById('managerAnalysis').classList.add('hidden');

            const highlightsList = productHighlights.map(h => `- ${h}`).join('\n');
            
            let annualReportContent = '';
            let websiteContent = '';

            const userPrompt = `
                I am a sales representative for ${myCompanyName} and our website is ${myCompanyWebsite}. My name is ${myName} and my role is ${myRole}. My goal is to send a cold email to a customer.
                
                My Company's Value Proposition: ${myServices}

                I need you to generate three different email drafts in three distinct tones: Professional, Engaging, and Relaxed. The primary focus MUST be on the customer's challenges and how my services can solve their pain points, rather than listing general features of my company.
                
                Here is the customer's information:
                - Customer Name: ${customerName}
                - Customer Business: ${customerCompany}
                - Customer Website: ${customerWebsite}
                - Customer LinkedIn Profile: ${customerLinkedinProfile}
                - Customer Personality Type: ${customerPersonalityType || 'Not specified'}
                - Competitor Solution (currently used): ${competitorSolution || 'Not specified'}
                - Customer Annual Report content: ${annualReportContent || 'Not provided'}

                ${myCompanyName} solutions key highlights:
                ${highlightsList}
                
                Additional context from their website search:
                ${websiteContent}

                For each email, please act as a sales agent. 
                
                *Crucial Instruction:* Identify the customer's current role/title based on the information provided, or infer a likely executive role (e.g., Head of Operations, CFO) based on their business. 
                
                The pitch must be tailored to the **specific priorities of that role**. For example, if the role is 'CFO', focus on cost reduction and ROI. If the role is 'Head of Supply Chain', focus on efficiency and risk reduction. In the message, clearly reference the role and why the proposed value is vital for your job.

                For the 'Professional' tone, be formal, data-driven, and focus on ROI.
                For the 'Engaging' tone, be more conversational, use storytelling, and focus on future-state benefits.
                For the 'Relaxed' tone, be friendly, brief, and to the point, respecting their time.

                The email body should be formatted using HTML tags such as <p>, <strong>, and <br> to create a professional and structured email.

                Please provide the output in a JSON format. The JSON should be a single array containing three objects, one for each tone. Each object must have three properties: 'tone', 'subject', and 'body'.
                
                // IMPORTANT: Generate the response in the language selected by the user: ${currentLang}
            `;

            let lengthConstraint = '';
            if (messageLength === 'short') {
                lengthConstraint = 'Be very concise, around 50-75 words.';
            } else if (messageLength === 'moderate') {
                lengthConstraint = 'Be moderate in length, around 120-180 words.';
            } else if (messageLength === 'detailed') {
                lengthConstraint = 'Be comprehensive and detailed, around 200-300 words.';
            } else { // Surprise me
                lengthConstraint = 'Vary the length and structure of each email to provide different options.';
            }
            
            const finalPrompt = userPrompt + `\n\nFor the length of the email body: ${lengthConstraint}`;

            try {
                const isLocal = window.location.hostname === 'localhost' || window.location.protocol === 'file:';
                
                if (isLocal) {
                    console.error("Local execution detected. Skipping API call.");
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('results').classList.remove('hidden');
                    const errorMessage = `
                        <div class="mt-8 text-center text-red-600 p-4 bg-red-100 border border-red-200 rounded-md">
                            <p class="font-bold">${languageData[currentLang].featureUnavailable}</p>
                            <p class="text-sm mt-1">${languageData[currentLang].deployMessage}</p>
                            <p class="text-sm mt-1">
                                <a href="https://vercel.com" target="_blank" class="text-blue-600 hover:underline">Deploy to Vercel</a>
                            </p>
                        </div>
                    `;
                    document.getElementById('results').innerHTML = errorMessage;
                    return;
                }
                
                const payload = { prompt: finalPrompt };
                const apiUrl = '/api/generate';

                let retryCount = 0;
                const maxRetries = 3;
                const baseDelay = 1000;

                const callApi = async () => {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && retryCount < maxRetries) {
                        retryCount++;
                        const delay = baseDelay * Math.pow(2, retryCount - 1);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callApi();
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }
                    return response.json();
                };

                const result = await callApi();
                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonString) {
                    throw new Error("Invalid response from API. Please try again.");
                }
                const emails = JSON.parse(jsonString);

                const bestTone = getBestTone(customerPersonalityType);
                if (isFirebaseActive) {
                    await saveEmailToFirestore(customerName, customerCompany, bestTone);
                }

                const emailContainer = document.getElementById('emailContainer');
                emailContainer.innerHTML = ''; // Clear previous emails

                emails.forEach(email => {
                    const isRecommended = email.tone === bestTone;
                    const cardClass = isRecommended ? 'bg-blue-50 border-blue-200 shadow-lg' : 'bg-slate-50 border-slate-100 shadow-md';
                    const titleClass = isRecommended ? 'text-blue-800' : 'text-slate-700';
                    const mailtoLink = `mailto:?subject=${encodeURIComponent(email.subject)}&body=${encodeURIComponent(email.body.replace(/<br>/g, '\n').replace(/<\/p>/g, '\n\n').replace(/<[^>]*>/g, ''))}`;

                    const emailCard = `
                        <div class="rounded-lg p-6 border ${cardClass}">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-semibold ${titleClass}">${email.tone} Tone ${isRecommended ? '<span class="text-sm font-normal text-blue-600">(Recommended)</span>' : ''}</h3>
                                <div class="flex space-x-2">
                                    <a href="${mailtoLink}" class="mail-btn flex items-center p-2 text-sm font-medium text-slate-600 hover:text-blue-600 transition-colors duration-200" title="${languageData[currentLang].sendEmailButton}">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-1">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                                        </svg>
                                        ${languageData[currentLang].sendEmailButton}
                                    </a>
                                    <button type="button" class="copy-btn flex items-center p-2 text-sm font-medium text-slate-600 hover:text-blue-600 transition-colors duration-200" data-subject="${email.subject}" data-body="${email.body}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2M9 14h6M9 18h6" />
                                        </svg>
                                        ${languageData[currentLang].copyButton}
                                    </button>
                                </div>
                            </div>
                            <p class="font-bold text-slate-800" data-lang="subjectLabel">Subject: <span class="subject">${email.subject}</span></p>
                            <div class="mt-2 text-slate-600 body-html">${email.body}</div>
                        </div>
                    `;
                    emailContainer.innerHTML += emailCard;
                });
                
                // Add event listeners to the new copy buttons
                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const subject = button.dataset.subject;
                        const body = button.dataset.body;
                        copyToClipboard(subject, body, button);
                    });
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                displayAnalysis(customerPersonalityType, bestTone);

            } catch (error) {
                console.error('Error generating emails:', error);
                document.getElementById('loading').classList.add('hidden');
                const errorMessage = `
                    <div class="mt-8 text-center text-red-600 p-4 bg-red-100 border border-red-200 rounded-md">
                        <p>${languageData[currentLang].analysisTitle}</p>
                        <p class="text-sm mt-1">${error.message}</p>
                    </div>
                `;
                document.getElementById('results').innerHTML = errorMessage;
                document.getElementById('results').classList.remove('hidden');
            }
        });

        // Function to determine the best tone based on personality type
        function getBestTone(customerPersonalityType) {
            switch(customerPersonalityType) {
                case 'Analytical':
                    return 'Professional';
                case 'Driver':
                    return 'Professional';
                case 'Amiable':
                    return 'Engaging';
                case 'Expressive':
                    return 'Engaging';
                default:
                    return 'Relaxed'; // Default to a less-intrusive tone
            }
        }
        
        // Function to display the sales manager analysis
        function displayAnalysis(customerPersonalityType, recommendedTone) {
            const analysisText = document.getElementById('analysisText');
            let text = '';
            const data = languageData[currentLang];

            if (customerPersonalityType) {
                text = `${data.analysisBase} (${customerPersonalityType}), ${data.analysisRecommendation} <span class="font-semibold text-blue-900">${recommendedTone}</span> ${data.analysisTone}. ${data.analysisConclusion}`;
            } else {
                text = `${data.analysisNoPersonality} <span class="font-semibold text-blue-900">${recommendedTone}</span> ${data.analysisTone}.`;
            }
            analysisText.innerHTML = text;
            document.getElementById('managerAnalysis').classList.remove('hidden');
        }

        async function saveEmailToFirestore(customerName, customerCompany, bestTone) {
            if (!userId) {
                console.error("No user ID found, cannot save to Firestore.");
                return;
            }

            const publicCollectionPath = `artifacts/${appId}/public/data/emails`;
            const docRef = await addDoc(collection(db, publicCollectionPath), {
                userId: userId,
                customerName: customerName,
                customerCompany: customerCompany,
                bestTone: bestTone,
                timestamp: serverTimestamp(),
            });
            console.log("Document successfully written with ID: ", docRef.id);
        }

        // Function to copy email content to clipboard
        async function copyToClipboard(subject, body, button) {
            // Remove HTML tags from the body for clean text copy
            const textToCopy = `Subject: ${subject}\n\n${body.replace(/<br>/g, '\n').replace(/<\/p>/g, '\n\n').replace(/<[^>]*>/g, '')}`;

            try {
                // Use the modern clipboard API
                await navigator.clipboard.writeText(textToCopy);
                
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    ${languageData[currentLang].copiedText}
                `;
                setTimeout(() => {
                    button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2M9 14h6M9 18h6" />
                        </svg>
                        ${languageData[currentLang].copyButton}
                    `;
                }, 2000);

            } catch (err) {
                // Fallback for older browsers or if modern API fails
                console.error('Failed to copy using modern API. Falling back to execCommand:', err);
                const textarea = document.createElement('textarea');
                textarea.value = textToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                     button.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        ${languageData[currentLang].copiedText}
                    `;
                    setTimeout(() => {
                        button.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-2M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v2M9 14h6M9 18h6" />
                            </svg>
                            ${languageData[currentLang].copyButton}
                        `;
                    }, 2000);
                } catch (execErr) {
                    console.error('Fallback copy method also failed:', execErr);
                } finally {
                    document.body.removeChild(textarea);
                }
            }
        }
    </script>
</body>
</html>
